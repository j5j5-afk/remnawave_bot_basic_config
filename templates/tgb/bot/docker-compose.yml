services:
  postgres:
    image: postgres:15-alpine
    container_name: remnawave_bot_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-remnawave_bot}
      POSTGRES_USER: ${POSTGRES_USER:-remnawave_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secure_password_123}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    networks:
      - bot_network
      - remnawave-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-remnawave_user} -d ${POSTGRES_DB:-remnawave_bot}"]
      interval: 2s
      timeout: 2s
      retries: 5
      start_period: 1s

  redis:
    image: redis:7-alpine
    container_name: remnawave_bot_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - ./redis_data:/data
    networks:
      - bot_network
      - remnawave-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 2s
      retries: 3
      start_period: 1s

  bot:
    build: /opt/webapp/remnawave-bedolaga-telegram-bot
    image: remnawave/bot:latest
    container_name: remnawave_bot
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Technically should be stripped, awaiting for the fix in repository to get rid of it
    env_file:
      - .env
    environment:
      DOCKER_ENV: "true"
      DATABASE_MODE: "auto"
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-remnawave_bot}
      POSTGRES_USER: ${POSTGRES_USER:-remnawave_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secure_password_123}
      REDIS_URL: "redis://redis:6379/0"
      # Avoid using this, better to keep as UTC
      # TZ: "Europe/Moscow"
      LOCALES_PATH: ${LOCALES_PATH:-/app/locales}
    volumes:
      # Using .env binding just to override the old (built in Dockerfile from repo copies files) one, awaiting for the fix to be included still
      - ./.env:/app/.env:ro
      # Doesn't seem to be used by anything so look for it inside of .env
      - /opt/tgb/bot/logs:/app/logs:rw
      # Seems like its only used by BACKUP_LOCATION (backup services) (BRANDING and branding related files)
      - /opt/tgb/bot/data:/app/data:rw
      # Not sure what it used by, but as you can see its been mentioned above LOCALES_PATH
      - /opt/tgb/bot/locales:/app/locales:rw
      # Not sure what it is used by but being generated by remnawave panel itself, get your own copy in your own panel
      - /opt/tgb/bot/app-config.json:/app/app-config.json:ro
      # Must match LOGO_FILE in env
      - /opt/tgb/bot/vpn_logo.png:/app/vpn_logo.png:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "${WEB_API_PORT:-8080}:8080"
    networks:
      - bot_network
      - remnawave-network
    healthcheck:
      test: >
        CMD-SHELL python -c "import requests, os; r=requests.get('http://localhost:8080/health', headers={'X-API-Key': os.environ.get('WEB_API_DEFAULT_TOKEN')}, timeout=1); exit(0) if r.status_code == 200 else exit(1)"
      interval: 5s
      timeout: 2s
      retries: 3
      start_period: 1s

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  bot_network:
    name: remnawave-bot-network
    driver: bridge

  remnawave-network:
    name: remnawave-network
    external: true